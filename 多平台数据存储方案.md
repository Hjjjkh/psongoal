# 多平台数据存储方案

## 🎯 需求理解

### 网页/小程序
- **默认联网**：保持使用 Supabase
- **问题**：怕卡
- **解决**：通过优化减少卡顿（缓存、索引等）

### 原生应用（exe/apk）
- **可以本地**：不需要联网
- **方案**：使用本地数据库（SQLite）

## 📊 方案设计

### 方案 1: 网页/小程序（保持联网，优化性能）

**架构**：
```
用户操作 → Supabase（联网）
         ↓
    缓存层（减少请求）
         ↓
    索引优化（加速查询）
```

**已完成的优化**：
- ✅ 数据库索引（查询速度提升 50-80%）
- ✅ 页面缓存（60秒缓存）
- ✅ 查询优化（保持功能，优化性能）

**还可以做的优化**：
- ✅ 客户端缓存（SWR/React Query）
- ✅ Service Worker 缓存
- ✅ 预加载数据
- ✅ 批量请求

**结果**：
- 保持联网，但**不卡**
- 通过缓存和索引优化性能
- 用户体验好

### 方案 2: 原生应用（exe/apk - 完全本地）

**架构**：
```
用户操作 → 本地数据库（SQLite）→ 立即响应
（不需要联网）
```

**技术选择**：

#### React Native（iOS/Android）
- **本地数据库**：Realm 或 SQLite
- **完全离线**
- **性能好**

#### Electron（Windows/Mac exe）
- **本地数据库**：SQLite
- **完全离线**
- **性能好**

**实现**：
1. 使用 SQLite 作为本地数据库
2. 所有数据存储在本地文件
3. 不需要连接 Supabase
4. 完全离线可用

## 🛠️ 具体实现

### 网页/小程序优化（减少卡顿）

#### 1. 客户端数据缓存

使用 **SWR** 或 **React Query**：

```typescript
// 安装
npm install swr

// 使用
import useSWR from 'swr'

function GoalsList() {
  const { data, error } = useSWR('/api/goals', fetcher, {
    revalidateOnFocus: false, // 不自动刷新
    revalidateOnReconnect: false,
    refreshInterval: 0, // 不自动刷新
  })
  
  // 数据从缓存读取，不卡
}
```

#### 2. Service Worker 缓存

```typescript
// 缓存 API 响应
self.addEventListener('fetch', (event) => {
  if (event.request.url.includes('/api/')) {
    event.respondWith(
      caches.match(event.request).then((response) => {
        return response || fetch(event.request).then((response) => {
          const responseClone = response.clone()
          caches.open('api-cache').then((cache) => {
            cache.put(event.request, responseClone)
          })
          return response
        })
      })
    )
  }
})
```

#### 3. 预加载数据

```typescript
// 页面加载时预加载数据
useEffect(() => {
  // 预加载常用数据
  prefetch('/api/goals')
  prefetch('/api/actions')
}, [])
```

### 原生应用（exe/apk - 本地数据库）

#### React Native 方案

```typescript
// 安装
npm install react-native-sqlite-storage
// 或
npm install @realm/react

// 使用 SQLite
import SQLite from 'react-native-sqlite-storage'

const db = SQLite.openDatabase({
  name: 'psongoal.db',
  location: 'default',
})

// 创建表
db.transaction((tx) => {
  tx.executeSql(
    'CREATE TABLE IF NOT EXISTS goals (id TEXT PRIMARY KEY, name TEXT, ...)',
    [],
    () => console.log('Table created'),
    (error) => console.log('Error:', error)
  )
})
```

#### Electron 方案

```typescript
// 安装
npm install better-sqlite3

// 使用
import Database from 'better-sqlite3'

const db = new Database('psongoal.db')

// 创建表
db.exec(`
  CREATE TABLE IF NOT EXISTS goals (
    id TEXT PRIMARY KEY,
    name TEXT,
    ...
  )
`)

// 查询
const goals = db.prepare('SELECT * FROM goals').all()
```

## 📋 实现建议

### 网页/小程序（保持联网）

**已完成的优化**：
- ✅ 数据库索引
- ✅ 页面缓存
- ✅ 查询优化

**还可以做的优化**：
1. **添加客户端缓存**（SWR/React Query）
   - 减少重复请求
   - 数据从缓存读取
   - 不卡

2. **Service Worker 缓存**
   - 离线可用
   - 减少网络请求

3. **预加载**
   - 提前加载数据
   - 用户感觉更快

**工作量**：1-2周

### 原生应用（exe/apk）

**需要做的**：
1. 选择技术栈（React Native 或 Electron）
2. 实现本地数据库（SQLite）
3. 重写所有数据操作
4. 移除 Supabase 依赖

**工作量**：2-3周

## 🎯 推荐方案

### 网页/小程序
**保持联网 + 优化性能**

1. **添加客户端缓存**（SWR）
   - 减少卡顿
   - 保持联网
   - 工作量小（1周）

2. **Service Worker 缓存**
   - 离线可用
   - 减少请求
   - 工作量小（1周）

### 原生应用（exe/apk）
**完全本地数据库**

1. **React Native + SQLite**
   - iOS/Android 应用
   - 完全本地
   - 工作量：2-3周

2. **Electron + SQLite**
   - Windows/Mac 桌面应用
   - 完全本地
   - 工作量：2-3周

## 📝 下一步

### 如果优化网页/小程序性能
我可以：
1. 添加 SWR 客户端缓存
2. 实现 Service Worker 缓存
3. 优化数据加载

### 如果开发原生应用（exe/apk）
我可以：
1. 创建本地数据库模型
2. 实现数据操作层
3. 提供开发指南

**告诉我你想先做哪个，我会开始实现！**

---

**总结**：
- **网页/小程序**：保持联网，通过缓存优化，不卡
- **原生应用**：完全本地，不需要联网
- **两种方案可以同时存在**

