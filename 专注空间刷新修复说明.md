# 专注空间刷新修复说明

## 🐛 问题

今天任务完成后，复盘页面正常显示，但专注空间还显示旧的任务。

## 🔍 原因分析

1. **专注空间没有检查今天是否已完成**
   - 专注空间只获取 `currentAction`，没有检查今天是否已完成
   - 即使今天已完成，仍然显示之前的 action

2. **刷新机制不够强制**
   - 使用 `router.push()` + `router.refresh()` 可能不够及时
   - 需要更强制的方式刷新数据

## ✅ 解决方案

### 1. 在服务端检查今天是否已完成

在 `packages/web/app/focus/page.tsx` 中添加检查逻辑：

```typescript
// 检查今天是否已经完成行动
const today = getToday()
const { data: todayExecutions } = await supabase
  .from('daily_executions')
  .select('action_id, completed')
  .eq('user_id', user.id)
  .eq('date', today)
  .eq('completed', true)
  .limit(1)

// 如果今天已完成，清空 action（不显示）
const todayCompleted = !!(todayExecutions && todayExecutions.length > 0)
const finalAction = todayCompleted ? null : currentAction?.action || null
```

**效果**：
- 如果今天已完成，专注空间不显示行动
- 与今日页面的逻辑保持一致

### 2. 使用强制刷新

在 `packages/web/components/focus-space-view.tsx` 中：

```typescript
// 修改前
setTimeout(async () => {
  await router.push('/focus')
  router.refresh()
}, 1500)

// 修改后
setTimeout(() => {
  window.location.href = '/focus'
}, 1500)
```

**效果**：
- 使用 `window.location.href` 强制完整刷新页面
- 确保获取最新的服务端数据

## 📋 修改文件

1. `packages/web/app/focus/page.tsx`
   - 添加今天完成检查逻辑
   - 如果今天已完成，不显示 action

2. `packages/web/components/focus-space-view.tsx`
   - 使用 `window.location.href` 强制刷新

## 🎯 效果

修复后：
- ✅ 今天完成任务后，专注空间不再显示旧任务
- ✅ 与今日页面、复盘页面逻辑一致
- ✅ 完成操作后立即刷新，显示最新状态

## 🔄 测试步骤

1. 在今日页面完成一个行动
2. 进入专注空间
3. 确认不显示已完成的行动
4. 在专注空间完成行动
5. 确认页面刷新后不显示旧任务

---

**最后更新**: 2024-12-20

