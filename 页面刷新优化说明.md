# 页面刷新优化说明

## 🎯 问题

完成操作后跳转的页面没有及时更新，需要手动刷新才能看到最新数据。

## ✅ 解决方案

### 1. 添加 `router.refresh()` 调用

在完成操作后跳转时，添加 `router.refresh()` 强制刷新 Server Components 的数据：

**修改文件**：
- `packages/web/components/today-view.tsx`
- `packages/web/components/focus-space-view.tsx`

**修改内容**：
```typescript
// 完成操作后跳转时
await router.push('/dashboard')
router.refresh() // 强制刷新数据
```

### 2. 调整页面缓存策略

将关键页面的 `revalidate` 设置为 `0`，确保数据实时更新：

**修改文件**：
- `packages/web/app/dashboard/page.tsx` - `revalidate: 0`（从 60 改为 0）
- `packages/web/app/today/page.tsx` - 添加 `revalidate: 0`
- `packages/web/app/focus/page.tsx` - `revalidate: 0`（从 30 改为 0）
- `packages/web/app/goal-complete/page.tsx` - 添加 `revalidate: 0`
- `packages/web/app/page.tsx` - 添加 `revalidate: 0`

**说明**：
- `revalidate: 0` 表示禁用缓存，每次请求都获取最新数据
- 这确保了完成操作后立即跳转时能看到最新状态

## 📋 修改详情

### 1. `today-view.tsx`

**完成操作后的跳转逻辑**：
```typescript
const handleAnimationComplete = async () => {
  setShowCompletionAnimation(false)
  if (isGoalCompleted) {
    await router.push('/goal-complete')
    router.refresh() // 强制刷新数据
  } else {
    await router.push('/dashboard')
    router.refresh() // 强制刷新数据
  }
}
```

### 2. `focus-space-view.tsx`

**完成操作后的跳转逻辑**：
```typescript
if (result.success) {
  toast.success('行动已完成！', { duration: 2000 })
  setTimeout(async () => {
    await router.push('/focus')
    router.refresh() // 强制刷新数据
  }, 1500)
}
```

### 3. 页面缓存配置

所有关键页面都设置为 `revalidate: 0`：

```typescript
export const revalidate = 0
// 设置为 0 确保数据实时更新，完成操作后立即反映最新状态
```

## 🎯 效果

完成操作后：
1. ✅ 跳转到目标页面
2. ✅ 自动刷新数据
3. ✅ 立即显示最新状态
4. ✅ 无需手动刷新

## ⚠️ 注意事项

### 性能考虑

- `revalidate: 0` 会禁用缓存，每次请求都会重新获取数据
- 对于数据更新频繁的页面（如完成操作后），这是必要的
- 如果未来需要优化性能，可以考虑：
  - 使用客户端状态管理（如 SWR、React Query）
  - 使用乐观更新
  - 在特定场景下使用较短的缓存时间（如 `revalidate: 10`）

### 用户体验

- 完成操作后立即看到最新状态，提升用户体验
- 减少用户困惑（不需要手动刷新）
- 数据一致性更好

## 🔄 后续优化建议

1. **客户端状态管理**：
   - 考虑使用 SWR 或 React Query 进行客户端数据缓存
   - 在完成操作后立即更新客户端缓存

2. **乐观更新**：
   - 在完成操作时立即更新 UI
   - 如果 API 调用失败，回滚 UI 状态

3. **智能缓存**：
   - 根据页面类型设置不同的缓存策略
   - 数据更新频繁的页面使用 `revalidate: 0`
   - 数据相对稳定的页面使用较长的缓存时间

---

**最后更新**: 2024-12-20

