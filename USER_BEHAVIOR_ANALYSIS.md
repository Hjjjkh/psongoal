# 用户行为场景全面分析

## 一、用户状态分类

### 1.1 认证状态
- ✅ 已登录
- ❌ 未登录（重定向到登录页）

### 1.2 目标状态
- 无目标（新用户）
- 有目标但未设置当前目标
- 有当前目标但未完成
- 当前目标已完成

### 1.3 系统状态
- `current_goal_id = null`
- `current_goal_id != null && current_phase_id = null`
- `current_goal_id != null && current_phase_id != null && current_action_id = null`
- `current_goal_id != null && current_phase_id != null && current_action_id != null`

### 1.4 今日完成状态
- 今天已完成行动
- 今天未完成行动
- 今天未开始（无当前行动）

## 二、核心用户行为场景

### 场景1：新用户注册和首次使用
**用户操作流程：**
1. 注册账号 → 登录
2. 访问首页 `/` → 重定向到 `/goals`
3. 创建第一个目标（模板/手动）
4. 设置当前目标
5. 创建阶段和行动
6. 访问 `/today` 查看当前行动

**系统状态变化：**
- 初始：`system_states` 不存在 → 自动创建（全 null）
- 创建目标后：`goals` 表有记录，但 `system_states` 仍为 null
- 设置当前目标后：`system_states.current_goal_id` 有值
- 创建阶段后：`phases` 表有记录
- 创建行动后：`actions` 表有记录
- 设置当前行动后：`system_states.current_action_id` 有值

**逻辑检查点：**
- ✅ 新用户无目标时，首页重定向到 `/goals`
- ✅ 创建目标后，提示"设为当前目标"
- ✅ 设置当前目标后，`system_states` 正确更新
- ✅ 创建阶段/行动后，可以正常显示

### 场景2：创建目标（模板方式）
**用户操作流程：**
1. 访问 `/goals`
2. 点击"使用模板创建"
3. 选择类别（健康/学习/项目）
4. 编辑模板行动（可选）
5. 设置开始日期和结束日期（必填）
6. 设置行动数量
7. 提交创建

**系统状态变化：**
- 创建前：可能有当前目标（需要检查冲突）
- 创建后：`goals` 表新增记录，`phases` 表新增记录，`actions` 表批量新增记录
- `system_states` 不变（需要手动设置当前目标）

**逻辑检查点：**
- ✅ 如果已有当前目标且未完成，拒绝创建（409错误）
- ✅ 结束日期必填验证
- ✅ 模板行动可编辑
- ✅ 编辑后的行动数据正确保存
- ✅ 创建成功后，提示"设为当前目标"

### 场景3：创建目标（手动方式）
**用户操作流程：**
1. 访问 `/goals`
2. 点击"创建目标"
3. 填写目标信息
4. 设置开始日期和结束日期（必填）
5. 提交创建
6. 创建阶段
7. 创建行动

**系统状态变化：**
- 创建前：可能有当前目标（需要检查冲突）
- 创建后：`goals` 表新增记录
- 创建阶段后：`phases` 表新增记录
- 创建行动后：`actions` 表新增记录
- `system_states` 不变（需要手动设置当前目标）

**逻辑检查点：**
- ✅ 如果已有当前目标且未完成，拒绝创建（409错误）
- ✅ 结束日期必填验证
- ✅ 创建目标后，自动打开"创建阶段"对话框
- ✅ 创建阶段后，自动打开"创建行动"对话框（如果目标没有行动）

### 场景4：设置当前目标
**用户操作流程：**
1. 访问 `/goals`
2. 点击"设为当前目标"按钮
3. 系统自动设置第一个未完成的行动为当前行动

**系统状态变化：**
- 设置前：`system_states.current_goal_id = null` 或指向其他目标
- 设置后：`system_states.current_goal_id` 更新，`current_phase_id` 和 `current_action_id` 自动设置

**逻辑检查点：**
- ✅ 如果已有当前目标且未完成，拒绝设置（409错误）
- ✅ 自动找到第一个未完成的行动
- ✅ 如果目标已完成，禁用"设为当前目标"按钮
- ✅ 设置成功后，重定向到 `/today`

### 场景5：完成行动（今天第一次）
**用户操作流程：**
1. 访问 `/today`
2. 查看当前行动
3. 填写难度和精力
4. 点击"完成"按钮
5. 系统记录完成并推进到下一个行动

**系统状态变化：**
- 完成前：`actions.completed_at = null`，`daily_executions` 无今天记录
- 完成后：`actions.completed_at` 更新为当前时间，`daily_executions` 新增记录（completed=true），`system_states.current_action_id` 可能更新（如果还有下一个行动）

**逻辑检查点：**
- ✅ 如果今天已完成其他行动，拒绝完成（409错误，"每日唯一行动"约束）
- ✅ 如果行动已完成（`completed_at` 非空），拒绝完成（409错误）
- ✅ 完成成功后，创建 `daily_executions` 记录
- ✅ 如果有下一个行动，自动推进 `current_action_id`
- ✅ 如果目标完成，`current_action_id` 设为 null，目标状态更新为 completed
- ✅ 完成提示正确（"今日行动已完成" 或 "目标已完成"）
- ✅ 重定向正确（完成行动 → `/dashboard`，完成目标 → `/goal-complete`）

### 场景6：完成行动（今天已完成后再次尝试）
**用户操作流程：**
1. 今天已完成一个行动
2. 访问 `/today`
3. 系统显示"今日行动已完成"
4. 尝试再次完成（通过刷新/直接访问API）

**系统状态变化：**
- 状态：`daily_executions` 已有今天 completed=true 的记录
- 尝试完成：被拒绝（409错误）

**逻辑检查点：**
- ✅ `/today` 页面检测到今天已完成，显示完成提示
- ✅ API 层检查今天是否已完成，拒绝重复完成
- ✅ 不会创建重复的 `daily_executions` 记录
- ✅ 不会更新 `actions.completed_at`（如果已存在）

### 场景7：标记行动未完成
**用户操作流程：**
1. 访问 `/today`
2. 点击"标记为未完成"按钮
3. 系统记录未完成状态

**系统状态变化：**
- 标记前：`daily_executions` 可能无记录或 completed=false
- 标记后：`daily_executions` 新增或更新记录（completed=false），`actions.completed_at` 不变（仍为 null）

**逻辑检查点：**
- ✅ 如果行动已完成（`completed_at` 非空），拒绝标记（409错误）
- ✅ 标记成功后，创建或更新 `daily_executions` 记录（completed=false）
- ✅ `actions.completed_at` 不受影响（仍为 null）
- ✅ 标记后，可以再次完成

### 场景8：新的一天自动推进
**用户操作流程：**
1. 昨天完成了行动A
2. 今天访问 `/today`
3. 系统自动推进到行动B

**系统状态变化：**
- 访问前：`system_states.current_action_id` 指向行动A（已完成）
- 访问后：检测到行动A已完成，自动推进到行动B

**逻辑检查点：**
- ✅ 检测到当前行动已完成（`completed_at` 非空）
- ✅ 检查今天是否已完成（如果已完成，不推进，显示完成提示）
- ✅ 如果今天未完成，自动推进到下一个行动
- ✅ 如果目标完成，`current_action_id` 设为 null

### 场景9：查看复盘看板
**用户操作流程：**
1. 访问 `/dashboard`
2. 查看各种统计数据

**数据逻辑：**
- 今日完成状态：检查当前目标的行动今天是否完成
- 连续完成天数：跨目标计算，从今天或昨天开始往前计算
- 最近30天完成趋势：只显示当前目标的执行记录
- 难度和精力趋势：只统计已完成行动的数据

**逻辑检查点：**
- ✅ 如果今天未完成，显示"今日待完成"（橙色）
- ✅ 如果今天已完成，显示"今日已完成"（绿色）
- ✅ 连续完成天数计算正确（今天未完成时从昨天开始）
- ✅ 复盘数据只显示当前目标的数据
- ✅ 如果今天有行动但未完成，图表显示为"未完成"（橙色），不是"无记录"（灰色）

### 场景10：删除目标
**用户操作流程：**
1. 访问 `/goals`
2. 点击删除目标
3. 确认删除

**系统状态变化：**
- 删除前：`goals` 表有记录，`system_states` 可能指向该目标
- 删除后：`goals` 表记录删除，关联的 `phases` 和 `actions` 级联删除，`system_states` 相关字段清空

**逻辑检查点：**
- ✅ 如果删除的是当前目标，`system_states` 相关字段清空
- ✅ 级联删除 `phases` 和 `actions`
- ✅ 级联删除 `daily_executions`（如果数据库设置了外键约束）

### 场景11：删除阶段
**用户操作流程：**
1. 访问 `/goals`
2. 展开目标详情
3. 点击删除阶段
4. 确认删除

**系统状态变化：**
- 删除前：`phases` 表有记录，`system_states` 可能指向该阶段
- 删除后：`phases` 表记录删除，关联的 `actions` 级联删除，`system_states` 相关字段清空

**逻辑检查点：**
- ✅ 如果删除的是当前阶段，`system_states.current_phase_id` 和 `current_action_id` 清空
- ✅ 级联删除 `actions`

### 场景12：删除行动
**用户操作流程：**
1. 访问 `/goals`
2. 展开目标详情
3. 展开阶段详情
4. 点击删除行动
5. 确认删除

**系统状态变化：**
- 删除前：`actions` 表有记录，`system_states` 可能指向该行动
- 删除后：`actions` 表记录删除，`system_states.current_action_id` 清空（如果删除的是当前行动）

**逻辑检查点：**
- ✅ 如果删除的是当前行动，`system_states.current_action_id` 清空
- ✅ 如果删除的是已完成的行动，不影响 `daily_executions`（历史记录保留）

### 场景13：目标完成后
**用户操作流程：**
1. 完成最后一个行动
2. 系统检测到目标完成
3. 重定向到 `/goal-complete`
4. 查看完成统计
5. 创建新目标

**系统状态变化：**
- 完成前：`goals.status = 'active'`，`system_states.current_action_id` 指向最后一个行动
- 完成后：`goals.status = 'completed'`，`system_states.current_action_id = null`

**逻辑检查点：**
- ✅ 完成最后一个行动后，目标状态更新为 completed
- ✅ `system_states.current_action_id` 设为 null
- ✅ 重定向到 `/goal-complete`
- ✅ 完成统计正确显示
- ✅ 可以创建新目标（不再有冲突）

### 场景14：边界情况 - 并发完成
**用户操作流程：**
1. 用户同时打开两个标签页
2. 两个标签页都尝试完成同一个行动
3. 第一个请求成功，第二个请求被拒绝

**系统状态变化：**
- 第一个请求：成功完成，`actions.completed_at` 更新
- 第二个请求：检测到 `completed_at` 已存在，返回 409 错误

**逻辑检查点：**
- ✅ API 层检查 `actions.completed_at`，防止重复完成
- ✅ 返回 409 错误，而不是 500 错误
- ✅ 不会创建重复的 `daily_executions` 记录

### 场景15：边界情况 - 今天未完成但明天访问
**用户操作流程：**
1. 今天有当前行动但未完成
2. 明天访问 `/today`
3. 系统应该显示今天的行动还是明天的行动？

**系统状态变化：**
- 今天：`system_states.current_action_id` 指向行动A，`actions.completed_at = null`
- 明天：访问 `/today`，检测到行动A未完成，应该继续显示行动A（不推进）

**逻辑检查点：**
- ✅ 如果当前行动未完成，不自动推进
- ✅ 继续显示当前行动，直到用户完成或标记为未完成

### 场景16：边界情况 - 刷新页面
**用户操作流程：**
1. 访问 `/today`
2. 完成行动
3. 刷新页面
4. 系统应该显示什么？

**系统状态变化：**
- 完成前：`actions.completed_at = null`
- 完成后：`actions.completed_at` 有值，`daily_executions` 有今天记录
- 刷新后：检测到今天已完成，显示完成提示

**逻辑检查点：**
- ✅ 刷新后，检测到今天已完成，显示"今日行动已完成"
- ✅ 不会显示下一个行动（因为今天已完成）
- ✅ 不会创建重复的 `daily_executions` 记录

## 三、数据一致性检查

### 3.1 `actions.completed_at` vs `daily_executions.completed`
- `actions.completed_at` 是唯一真相源，表示行动是否完成
- `daily_executions.completed` 表示某天的执行状态
- 如果 `actions.completed_at` 非空，该行动永远不可再次完成
- 如果 `actions.completed_at` 为空，可以创建 `daily_executions` 记录（completed=true 或 false）

### 3.2 `system_states` vs 实际数据
- `system_states.current_action_id` 应该指向一个存在的、未完成的行动
- 如果指向的行动已完成，应该自动推进
- 如果指向的行动不存在，应该清空 `current_action_id`

### 3.3 每日唯一行动约束
- 每天只能完成一个行动
- 如果今天已完成行动A，不能完成行动B
- 检查逻辑：查询 `daily_executions` 中今天 completed=true 的记录

## 四、需要检查的关键逻辑

1. ✅ 新用户引导流程
2. ✅ 创建目标时的冲突检查
3. ✅ 设置当前目标时的冲突检查
4. ✅ **修复：设置当前目标时找到第一个未完成的行动**（之前只找第一个行动）
5. ✅ 完成行动时的"每日唯一行动"约束
6. ✅ 完成行动时的"已完成行动不可重复完成"约束
7. ✅ 自动推进逻辑（新的一天）
8. ✅ 目标完成检测
9. ✅ 删除操作时的状态清理
10. ✅ 复盘看板的数据范围（当前目标 vs 所有目标）
11. ✅ 今天未完成时的数据显示

## 五、发现并修复的问题

### 问题1：设置当前目标时未找到第一个未完成的行动
**问题描述：**
- 在 `app/api/set-current-goal/route.ts` 中，设置当前目标时只获取第一个 Phase 的第一个 Action
- 如果目标中前几个行动已完成，设置当前目标时会指向已完成的行动
- 虽然自动推进逻辑可以处理，但不够优雅

**修复方案：**
- 修改 `app/api/set-current-goal/route.ts`，遍历所有 Phase 和 Action，找到第一个未完成的 Action
- 如果所有行动都已完成，则使用第一个 Phase 的第一个 Action（用于已完成的目标）

**修复状态：** ✅ 已修复

### 问题2：今天未完成时的图表显示
**问题描述：**
- 如果今天有行动但未完成且未标记，`daily_executions` 可能为空
- 导致图表显示为"无记录"（灰色），而不是"未完成"（橙色）

**修复方案：**
- 在 `app/dashboard/page.tsx` 中，如果今天是今天且有当前行动但没有执行记录，设置 `total = 1, completed = 0`
- 这样图表会正确显示为"未完成"（橙色）

**修复状态：** ✅ 已修复

### 问题3：完成率计算
**问题描述：**
- 完成率基于固定的30天计算，如果用户只有1个任务完成，显示3%不合理

**修复方案：**
- 修改完成率计算逻辑，基于有记录的天数计算
- 如果有记录天数 < 30天，显示 `(完成天数/有记录天数)`

**修复状态：** ✅ 已修复

## 六、逻辑验证结果

### 场景1：新用户注册和首次使用
- ✅ 逻辑正确：新用户无目标时，首页重定向到 `/goals`
- ✅ 逻辑正确：创建目标后，提示"设为当前目标"
- ✅ 逻辑正确：设置当前目标后，`system_states` 正确更新
- ✅ 逻辑正确：创建阶段/行动后，可以正常显示

### 场景2-3：创建目标（模板/手动）
- ✅ 逻辑正确：如果已有当前目标且未完成，拒绝创建（409错误）
- ✅ 逻辑正确：结束日期必填验证
- ✅ 逻辑正确：模板行动可编辑
- ✅ 逻辑正确：创建成功后，提示"设为当前目标"

### 场景4：设置当前目标
- ✅ **修复后**：找到第一个未完成的行动，而不是第一个行动
- ✅ 逻辑正确：如果已有当前目标且未完成，拒绝设置（409错误）
- ✅ 逻辑正确：如果目标已完成，禁用"设为当前目标"按钮

### 场景5：完成行动（今天第一次）
- ✅ 逻辑正确：如果今天已完成其他行动，拒绝完成（409错误）
- ✅ 逻辑正确：如果行动已完成，拒绝完成（409错误）
- ✅ 逻辑正确：完成成功后，创建 `daily_executions` 记录
- ✅ 逻辑正确：如果有下一个行动，返回 `nextActionId`（但不立即推进）
- ✅ 逻辑正确：如果目标完成，`current_action_id` 设为 null

### 场景6：完成行动（今天已完成后再次尝试）
- ✅ 逻辑正确：API 层检查今天是否已完成，拒绝重复完成
- ✅ 逻辑正确：不会创建重复的 `daily_executions` 记录

### 场景7：标记行动未完成
- ✅ 逻辑正确：如果行动已完成，拒绝标记（409错误）
- ✅ 逻辑正确：标记成功后，创建或更新 `daily_executions` 记录（completed=false）

### 场景8：新的一天自动推进
- ✅ 逻辑正确：检测到当前行动已完成（`completed_at` 非空）
- ✅ 逻辑正确：检查今天是否已完成（如果已完成，不推进，显示完成提示）
- ✅ 逻辑正确：如果今天未完成，自动推进到下一个行动

### 场景9：查看复盘看板
- ✅ **修复后**：如果今天有行动但未完成，图表显示为"未完成"（橙色）
- ✅ 逻辑正确：如果今天已完成，显示"今日已完成"（绿色）
- ✅ 逻辑正确：连续完成天数计算正确（今天未完成时从昨天开始）
- ✅ 逻辑正确：复盘数据只显示当前目标的数据

### 场景10-12：删除操作
- ✅ 逻辑正确：删除目标/阶段/行动时，正确清理 `system_states` 相关字段

### 场景13：目标完成后
- ✅ 逻辑正确：完成最后一个行动后，目标状态更新为 completed
- ✅ 逻辑正确：`system_states.current_action_id` 设为 null
- ✅ 逻辑正确：重定向到 `/goal-complete`

### 场景14：并发完成
- ✅ 逻辑正确：API 层检查 `actions.completed_at`，防止重复完成
- ✅ 逻辑正确：返回 409 错误，而不是 500 错误

### 场景15：今天未完成但明天访问
- ✅ 逻辑正确：如果当前行动未完成，不自动推进
- ✅ 逻辑正确：继续显示当前行动，直到用户完成或标记为未完成

### 场景16：刷新页面
- ✅ 逻辑正确：刷新后，检测到今天已完成，显示"今日行动已完成"
- ✅ 逻辑正确：不会显示下一个行动（因为今天已完成）

## 七、数据一致性验证

### 7.1 `actions.completed_at` vs `daily_executions.completed`
- ✅ `actions.completed_at` 是唯一真相源，表示行动是否完成
- ✅ 如果 `actions.completed_at` 非空，该行动永远不可再次完成
- ✅ `daily_executions.completed` 表示某天的执行状态

### 7.2 `system_states` vs 实际数据
- ✅ `system_states.current_action_id` 应该指向一个存在的行动
- ✅ 如果指向的行动已完成，自动推进逻辑会处理
- ✅ 如果指向的行动不存在，应该清空 `current_action_id`

### 7.3 每日唯一行动约束
- ✅ 每天只能完成一个行动
- ✅ 检查逻辑：查询 `daily_executions` 中今天 completed=true 的记录
- ✅ API 层和业务逻辑层都有检查

## 八、总结

所有用户行为场景的逻辑检查已完成，发现并修复了以下问题：

1. ✅ **设置当前目标时找到第一个未完成的行动**（已修复）
2. ✅ **今天未完成时的图表显示**（已修复）
3. ✅ **完成率计算**（已修复）

所有关键逻辑已验证正确，系统行为符合设计预期。

